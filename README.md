# SimpleRDBMS

一个用C++实现的简化关系数据库管理系统，支持基本的SQL操作、事务处理、崩溃恢复和B+树索引。

## 📋 目录

- [项目概述](#项目概述)
- [系统架构](#系统架构)
- [已实现功能](#已实现功能)
- [未实现功能](#未实现功能)
- [快速开始](#快速开始)
- [编译和运行](#编译和运行)
- [测试](#测试)
- [性能特性](#性能特性)
- [贡献](#贡献)
- [许可证](#许可证)

## 🎯 项目概述

SimpleRDBMS 是一个教育性质的关系数据库管理系统，实现了现代DBMS的核心组件：

- **存储引擎**：页面式存储、缓冲池管理
- **索引系统**：高性能B+树索引
- **事务处理**：ACID特性、两阶段锁协议
- **恢复机制**：基于WAL的ARIES恢复算法
- **SQL解析**：支持基本DDL和DML语句
- **查询执行**：基于Volcano模型的执行引擎

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                    SQL Interface                         │
├─────────────────────────────────────────────────────────┤
│  Parser & AST  │  Execution Engine  │  Catalog Manager │
├─────────────────────────────────────────────────────────┤
│              Transaction Manager                         │
│  Lock Manager  │  Log Manager  │  Recovery Manager     │
├─────────────────────────────────────────────────────────┤
│  Record Manager  │  Index Manager (B+ Tree)            │
├─────────────────────────────────────────────────────────┤
│              Buffer Pool Manager                         │
│  LRU Replacer  │  Page Management                       │
├─────────────────────────────────────────────────────────┤
│              Storage Manager                             │
│  Disk Manager  │  Page I/O                             │
└─────────────────────────────────────────────────────────┘
```

## ✅ 已实现功能

### 🗄️ 存储层

#### 磁盘管理
- [x] **页面读写**：4KB页面的磁盘I/O操作
- [x] **页面分配与回收**：支持页面的动态分配和释放
- [x] **文件管理**：自动创建和管理数据库文件
- [x] **空闲页面重用**：维护已删除页面的重用列表

#### 缓冲池管理
- [x] **LRU页面替换**：最近最少使用算法
- [x] **页面固定机制**：Pin/Unpin页面引用计数
- [x] **并发访问控制**：多线程安全的缓冲池操作
- [x] **脏页管理**：自动检测和刷新修改过的页面

### 📊 记录管理

#### 元组处理
- [x] **多数据类型支持**：`INT`, `VARCHAR`, `FLOAT`, `DOUBLE`, `BOOLEAN`
- [x] **序列化机制**：高效的记录序列化和反序列化
- [x] **变长记录支持**：动态大小的VARCHAR字段
- [x] **RID管理**：记录标识符的完整支持

#### 表堆管理
- [x] **记录CRUD操作**：插入、删除、更新、查询
- [x] **页面链接管理**：多页面表的链表结构
- [x] **空间管理**：页面内空闲空间跟踪
- [x] **迭代器支持**：全表顺序扫描

### 🌲 索引系统

#### B+树核心功能
- [x] **多类型键支持**：`int32_t`, `int64_t`, `float`, `double`, `string`
- [x] **点查询**：O(log n)时间复杂度的精确查找
- [x] **范围查询**：基于迭代器的范围扫描
- [x] **插入操作**：支持重复键值的插入

#### B+树高级特性
- [x] **自动分裂**：节点满时的自动分裂机制
- [x] **节点合并**：删除时的节点合并优化
- [x] **重分布**：兄弟节点间的负载均衡
- [x] **持久化**：索引结构的完整持久化
- [x] **并发控制**：页面级别的读写锁

### 📝 SQL处理

#### 词法和语法分析
- [x] **SQL词法分析**：完整的Token识别
- [x] **语法解析**：生成抽象语法树(AST)
- [x] **错误处理**：语法错误的定位和报告

#### 支持的SQL语句
- [x] **CREATE TABLE**：建表语句（含约束）
```sql
CREATE TABLE users (
    id INT PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    age INT
);
```

- [x] **INSERT**：插入语句（支持多行）
```sql
INSERT INTO users VALUES (1, 'Alice', 25), (2, 'Bob', 30);
```

- [x] **SELECT**：基本查询语句
```sql
SELECT id, name FROM users;
```

- [x] **CREATE INDEX**：索引创建
```sql
CREATE INDEX idx_name ON users(name);
```

- [x] **DROP TABLE/INDEX**：删除操作

### 🔄 事务处理

#### 事务管理
- [x] **ACID属性**：原子性、一致性、隔离性、持久性
- [x] **事务状态跟踪**：GROWING、SHRINKING、COMMITTED、ABORTED
- [x] **隔离级别定义**：四种标准隔离级别
- [x] **事务ID管理**：唯一事务标识符分配

#### 锁管理
- [x] **两阶段锁协议**：严格的2PL实现
- [x] **共享锁/排他锁**：读写锁机制
- [x] **锁升级**：共享锁到排他锁的升级
- [x] **死锁预防**：基于超时的死锁预防
- [x] **锁队列管理**：每个资源的锁请求队列

### 📄 日志和恢复

#### WAL日志系统
- [x] **日志记录类型**：BEGIN、COMMIT、ABORT、INSERT、UPDATE
- [x] **LSN管理**：递增的日志序列号
- [x] **日志持久化**：Write-Ahead Logging
- [x] **日志读取**：恢复时的日志扫描

#### ARIES恢复算法
- [x] **三阶段恢复**：分析、重做、撤销
- [x] **活跃事务表**：崩溃恢复时的事务状态重建
- [x] **重做操作**：已提交事务的操作重放
- [x] **撤销操作**：未提交事务的回滚
- [x] **检查点机制**：定期创建恢复检查点

### 📚 元数据管理

#### Schema管理
- [x] **列定义**：数据类型、约束、大小限制
- [x] **表结构验证**：创建表时的完整性检查
- [x] **主键约束**：主键的唯一性保证
- [x] **NOT NULL约束**：非空约束的解析支持

#### 目录管理
- [x] **表管理**：表的创建、删除、查询
- [x] **索引管理**：索引的创建、删除、查询
- [x] **OID分配**：对象标识符的唯一分配
- [x] **元数据持久化**：系统表的管理

## ❌ 未实现功能

### 🔴 核心SQL功能（高优先级）

#### 基本DML操作
- [ ] **UPDATE语句**：记录更新操作
- [ ] **DELETE语句**：记录删除操作
- [ ] **复杂WHERE子句**：完整的条件表达式求值
- [ ] **JOIN操作**：内连接、外连接、交叉连接

#### 查询功能
- [ ] **聚合函数**：SUM, COUNT, AVG, MIN, MAX
- [ ] **GROUP BY**：分组查询
- [ ] **HAVING**：分组后过滤
- [ ] **ORDER BY**：结果排序
- [ ] **DISTINCT**：去重查询
- [ ] **LIMIT/OFFSET**：分页查询

### 🟡 高级SQL特性（中优先级）

#### 复杂查询
- [ ] **子查询**：标量子查询、EXISTS、IN
- [ ] **集合操作**：UNION、INTERSECT、EXCEPT
- [ ] **公共表表达式**：WITH子句(CTE)
- [ ] **窗口函数**：ROW_NUMBER、RANK等

#### 约束和完整性
- [ ] **外键约束**：引用完整性
- [ ] **UNIQUE约束**：唯一性约束的运行时检查
- [ ] **CHECK约束**：自定义约束条件
- [ ] **级联操作**：CASCADE DELETE/UPDATE

### 🟢 优化和性能（低优先级）

#### 查询优化
- [ ] **基于成本的优化器**：CBO查询优化
- [ ] **统计信息收集**：表和索引统计
- [ ] **执行计划优化**：多种执行策略选择
- [ ] **索引选择**：自动索引使用决策

#### 高级索引
- [ ] **复合索引**：多列索引的完整支持
- [ ] **部分索引**：带条件的索引
- [ ] **函数索引**：基于表达式的索引
- [ ] **全文索引**：文本搜索支持

### 🔵 系统特性（扩展功能）

#### 数据类型和函数
- [ ] **更多数据类型**：DATE、TIME、DECIMAL、BLOB
- [ ] **类型转换**：自动和显式类型转换
- [ ] **内置函数**：字符串、数学、日期函数
- [ ] **用户自定义函数**：UDF支持

#### 高级特性
- [ ] **视图**：虚拟表支持
- [ ] **存储过程**：服务器端编程
- [ ] **触发器**：事件驱动的数据库逻辑
- [ ] **序列**：自增序列生成器

#### 系统管理
- [ ] **用户权限管理**：认证和授权系统
- [ ] **数据库级操作**：CREATE/DROP DATABASE
- [ ] **备份恢复**：数据导入导出
- [ ] **性能监控**：查询性能分析工具

## 🚀 快速开始

### 系统要求

- **编译器**：支持C++17的编译器（GCC 7+, Clang 5+, MSVC 2017+）
- **构建系统**：CMake 3.10+
- **操作系统**：Linux, macOS, Windows

### 安装

```bash
# 克隆仓库
git clone https://github.com/your-username/SimpleRDBMS.git
cd SimpleRDBMS

# 创建构建目录
mkdir build && cd build

# 配置和编译
cmake ..
make -j4

# 运行主程序
./simpledb database.db
```

### 基本使用

```bash
# 启动数据库
SimpleRDBMS> CREATE TABLE students (id INT PRIMARY KEY, name VARCHAR(50), grade FLOAT);
Query executed successfully.

SimpleRDBMS> INSERT INTO students VALUES (1, 'Alice', 95.5), (2, 'Bob', 87.2);
Query executed successfully.

SimpleRDBMS> SELECT * FROM students;
Query executed successfully.
Results: 2 rows

SimpleRDBMS> exit
```

## 🔧 编译和运行

### 构建选项

```bash
# Debug版本
cmake -DCMAKE_BUILD_TYPE=Debug ..

# Release版本
cmake -DCMAKE_BUILD_TYPE=Release ..

# 启用测试
cmake -DENABLE_TESTING=ON ..
```

### 依赖项

项目采用现代C++标准库，无外部依赖：
- STL容器和算法
- 标准文件I/O
- 线程和同步原语
- 智能指针

## 🧪 测试

### 运行测试套件

```bash
# 编译测试
make test_main

# 运行基础测试
./test/unit/test_main

# 运行综合测试
./test/comprehensive_test

# 运行B+树性能测试
./test/unit/bplus_tree_performance_test

# 运行简单功能测试
./test/unit/simple_bplus_test
```

### 测试覆盖

- **单元测试**：各个组件的独立测试
- **集成测试**：模块间协作测试
- **性能测试**：B+树索引性能基准
- **并发测试**：多线程环境正确性验证
- **恢复测试**：崩溃恢复场景测试

## 📈 性能特性

### 基准测试结果

#### B+树索引性能
- **插入性能**：~50,000 插入/秒
- **查询性能**：~100,000 查询/秒
- **范围扫描**：~80,000 记录/秒
- **内存使用**：~32字节/记录开销

#### 事务处理性能
- **事务吞吐**：~10,000 事务/秒
- **锁获取延迟**：~50微秒
- **日志写入**：~20,000 日志记录/秒

### 扩展性

- **表大小**：支持TB级别的表
- **并发连接**：理论上无限制（受系统资源限制）
- **索引数量**：每表支持多个索引
- **事务大小**：支持长事务

## 🤝 贡献

欢迎贡献代码！请遵循以下步骤：

1. **Fork项目**
2. **创建特性分支** (`git checkout -b feature/AmazingFeature`)
3. **提交更改** (`git commit -m 'Add some AmazingFeature'`)
4. **推送分支** (`git push origin feature/AmazingFeature`)
5. **创建Pull Request**

### 代码规范

- 遵循Google C++代码风格
- 添加适当的注释和文档
- 确保所有测试通过
- 更新相关的README和文档

### 优先贡献领域

1. **UPDATE/DELETE语句实现**
2. **JOIN操作支持**
3. **聚合函数实现**
4. **查询优化器**
5. **更多数据类型支持**

## 📜 许可证

本项目采用MIT许可证 - 详见 [LICENSE](LICENSE) 文件。

## 🙏 致谢

- 感谢CMU 15-445数据库系统课程的启发
- 参考了SQLite和PostgreSQL的设计思想
- 感谢所有贡献者的支持

## 📞 联系方式

- **项目维护者**：[您的姓名]
- **邮箱**：your.email@example.com
- **项目主页**：https://github.com/your-username/SimpleRDBMS

---

**注意**：这是一个教育性质的数据库系统，不建议在生产环境中使用。如需生产级别的数据库，请使用PostgreSQL、MySQL等成熟的数据库系统。